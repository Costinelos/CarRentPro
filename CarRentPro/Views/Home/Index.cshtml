@model IEnumerable<CarRentPro.Models.Vehicle>

@{
    ViewData["Title"] = "Home Page";

    // Extrage marca si anii pt dropdown
    var allBrands = Model.Select(v => v.Brand).Distinct().OrderBy(b => b).ToList();
    var allYears = Model.Select(v => v.Year).Distinct().OrderByDescending(y => y).ToList();
}

<div class="container">
    <!-- Hero Section -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-4">Welcome to CarRentPro</h1>
            <p class="lead">Find the perfect car for your journey</p>

            <!-- Search Form -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <!-- Search Form -->
                    <form method="get" asp-controller="Vehicle" asp-action="Search" class="card p-4 shadow-sm mb-3" id="searchForm">
                        <div class="row g-3">
                            <!-- Search Input -->
                            <div class="col-md-8">
                                <label class="form-label">Search Vehicles</label>
                                <div class="input-group position-relative">
                                    <input type="text"
                                           class="form-control"
                                           name="searchTerm"
                                           placeholder="Search by brand, model, color, year..."
                                           id="searchInput"
                                           autocomplete="off"
                                           value="@Context.Request.Query["searchTerm"]">
                                    <button class="btn btn-primary" type="submit" id="searchButton">
                                        <i class="fas fa-search"></i> Search
                                    </button>

                                    <!-- Autocomplete Dropdown -->
                                    <div id="autocompleteResults" class="autocomplete-dropdown"></div>
                                </div>
                            </div>

                            
                           
                        </div>

                        <!-- Advanced Filters (Collapsible) -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#advancedFilters" role="button">
                                    <i class="fas fa-filter"></i> Advanced Filters
                                </a>

                                <div class="collapse mt-3" id="advancedFilters">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Brand</label>
                                            <select class="form-select" name="brandFilter" id="brandFilter">
                                                <option value="">All Brands</option>
                                                @foreach (var brand in allBrands)
                                                {
                                                    <option value="@brand">@brand</option>
                                                }
                                            </select>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label">Year</label>
                                            <select class="form-select" name="yearFilter" id="yearFilter">
                                                <option value="">All Years</option>
                                                @foreach (var year in allYears)
                                                {
                                                    <option value="@year">@year</option>
                                                }
                                            </select>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label">Price Range</label>
                                            <select class="form-select" name="priceFilter" id="priceFilter">
                                                <option value="">Any Price</option>
                                                <option value="0-50">$0 - $50</option>
                                                <option value="51-100">$51 - $100</option>
                                                <option value="101-200">$101 - $200</option>
                                                <option value="201-500">$201 - $500</option>
                                                <option value="501+">$501+</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-12 text-end">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search"></i> Apply Filters
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Quick Search Tags -->
                    <div class="text-center">
                        <small class="text-muted">Quick search:</small>
                        <div class="mt-2">
                            @foreach (var brand in allBrands.Take(5))
                            {
                                <a href="@Url.Action("Search", "Vehicle", new { searchTerm = brand })" class="btn btn-sm btn-outline-primary me-2 mb-2">
                                    @brand
                                </a>
                            }
                            <a href="@Url.Action("Search", "Vehicle", new { availabilityFilter = "available" })" class="btn btn-sm btn-outline-success me-2 mb-2">
                                <i class="fas fa-check"></i> Available
                            </a>
                            <a href="@Url.Action("Search", "Vehicle", new { yearFilter = DateTime.Now.Year.ToString() })" class="btn btn-sm btn-outline-info me-2 mb-2">
                                New @DateTime.Now.Year
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Vehicle Grid -->
    @if (Model.Any())
    {
        <div class="row" id="vehicleGrid">
            @foreach (var vehicle in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4 vehicle-card"
                     data-brand="@vehicle.Brand"
                     data-model="@vehicle.Model"
                     data-year="@vehicle.Year"
                     data-color="@vehicle.Color"
                     data-price="@vehicle.PricePerDay"
                     data-branch="@vehicle.Branch?.Name"
                     data-available="@vehicle.IsAvailable.ToString().ToLower()">
                    <div class="card h-100 shadow-sm">
                        <img src="@vehicle.ImageUrl"
                             class="card-img-top vehicle-image"
                             alt="@vehicle.Brand @vehicle.Model"
                             onerror="this.onerror=null; this.src='/images/vehicles/default-car.jpg'">

                        <div class="card-body">
                            <h5 class="card-title">@vehicle.Brand @vehicle.Model</h5>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-calendar-alt"></i> @vehicle.Year<br>
                                    <i class="fas fa-palette"></i> @vehicle.Color<br>
                                    <i class="fas fa-map-marker-alt"></i> @vehicle.Branch?.Name
                                </small>
                            </p>
                            <p class="card-text vehicle-description">@vehicle.Description</p>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="h5 mb-0 text-primary">$@string.Format("{0:F2}", vehicle.PricePerDay)/day</span>
                                @if (vehicle.IsAvailable)
                                {
                                    <span class="badge bg-success">Available</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Rented</span>
                                }
                            </div>
                            <div class="mt-2">
                                @if (vehicle.IsAvailable)
                                {
                                    <a href="@Url.Action("Rent", "Rental", new { id = vehicle.Id })"
                                       class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-car"></i> Rent Now
                                    </a>
                                }
                                else
                                {
                                    <a href="@Url.Action("Details", "Vehicle", new { id = vehicle.Id })"
                                       class="btn btn-secondary btn-sm w-100">
                                        <i class="fas fa-info-circle"></i> View Details
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12 text-center">
                <div class="alert alert-info">
                    <h4><i class="fas fa-car me-2"></i>No vehicles available at the moment</h4>
                    <p>Please check back later or try our <a href="@Url.Action("Search", "Vehicle")" class="alert-link">advanced search</a>.</p>
                </div>
            </div>
        </div>
    }

    <!-- View All Button -->
    @if (Model.Any())
    {
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="@Url.Action("Search", "Vehicle")" class="btn btn-outline-primary">
                    <i class="fas fa-list"></i> View All Vehicles
                </a>
            </div>
        </div>
    }
</div>

<style>
    .vehicle-image {
        height: 200px;
        object-fit: cover;
        width: 100%;
    }

    .vehicle-card {
        transition: transform 0.2s;
    }

        .vehicle-card:hover {
            transform: translateY(-5px);
        }

    .card {
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

        .card:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

    /* Autocomplete styles */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 4px 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f5;
        transition: background-color 0.2s;
    }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .autocomplete-item.highlight {
            background-color: #e9ecef;
        }

    .autocomplete-category {
        padding: 8px 15px;
        background-color: #f8f9fa;
        font-weight: bold;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
    }

    .vehicle-description {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 48px;
    }
</style>

@section Scripts {
    <script>
     
        let vehicleSuggestions = [];

        document.addEventListener('DOMContentLoaded', function() {
        
            const cards = document.querySelectorAll('.vehicle-card');
            vehicleSuggestions = [];

            cards.forEach(card => {
                const brand = card.dataset.brand || '';
                const model = card.dataset.model || '';
                const year = card.dataset.year || '';
                const color = card.dataset.color || '';
                const branch = card.dataset.branch || '';
                const price = card.dataset.price || '';

               
                if (brand && !vehicleSuggestions.some(s => s.text === brand)) {
                    vehicleSuggestions.push({ text: brand, type: 'brand' });
                }
                if (model && !vehicleSuggestions.some(s => s.text === model)) {
                    vehicleSuggestions.push({ text: model, type: 'model' });
                }
                if (color && !vehicleSuggestions.some(s => s.text === color)) {
                    vehicleSuggestions.push({ text: color, type: 'color' });
                }
                if (branch && !vehicleSuggestions.some(s => s.text === branch)) {
                    vehicleSuggestions.push({ text: branch, type: 'branch' });
                }
                if (year && !vehicleSuggestions.some(s => s.text === year.toString())) {
                    vehicleSuggestions.push({ text: year.toString(), type: 'year' });
                }
            });

           
            vehicleSuggestions.sort((a, b) => a.text.localeCompare(b.text));

            initializeAutocomplete();
            populateFilterValuesFromUrl();
        });

        function initializeAutocomplete() {
            const searchInput = document.getElementById('searchInput');
            const autocompleteResults = document.getElementById('autocompleteResults');
            let selectedIndex = -1;

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query.length < 1) {
                    autocompleteResults.style.display = 'none';
                    return;
                }

                const filtered = vehicleSuggestions.filter(suggestion =>
                    suggestion.text.toLowerCase().includes(query)
                );

                const grouped = {};
                filtered.forEach(suggestion => {
                    if (!grouped[suggestion.type]) {
                        grouped[suggestion.type] = [];
                    }
                    grouped[suggestion.type].push(suggestion);
                });

                if (Object.keys(grouped).length > 0) {
                    let html = '';

                    const categoryOrder = ['brand', 'model', 'color', 'year', 'branch'];

                    categoryOrder.forEach(category => {
                        if (grouped[category]) {
                            const categoryName = {
                                'brand': 'Brands',
                                'model': 'Models',
                                'color': 'Colors',
                                'year': 'Years',
                                'branch': 'Branches'
                            }[category];

                            html += `<div class="autocomplete-category">${categoryName}</div>`;

                            grouped[category].forEach((suggestion, index) => {
                                const isHighlight = (selectedIndex === Object.keys(grouped).indexOf(category) + index);
                                html += `<div class="autocomplete-item ${isHighlight ? 'highlight' : ''}"
                                           data-value="${suggestion.text}">${suggestion.text}</div>`;
                            });
                        }
                    });

                    autocompleteResults.innerHTML = html;
                    autocompleteResults.style.display = 'block';

                    document.querySelectorAll('.autocomplete-item').forEach((item, index) => {
                        item.addEventListener('click', function() {
                            searchInput.value = this.dataset.value;
                            autocompleteResults.style.display = 'none';
                            
                            setTimeout(() => {
                                document.getElementById('searchForm').submit();
                            }, 100);
                        });
                    });
                } else {
                    autocompleteResults.style.display = 'none';
                }
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = document.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        searchInput.value = items[selectedIndex].dataset.value;
                        autocompleteResults.style.display = 'none';
                        document.getElementById('searchForm').submit();
                    } else {
                        document.getElementById('searchForm').submit();
                    }
                } else if (e.key === 'Escape') {
                    autocompleteResults.style.display = 'none';
                    selectedIndex = -1;
                }
            });

           
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
                    autocompleteResults.style.display = 'none';
                    selectedIndex = -1;
                }
            });

           
            document.getElementById('searchButton').addEventListener('click', function() {
                document.getElementById('searchForm').submit();
            });
        }

        function updateHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlight', index === selectedIndex);
            });
        }

       
        function populateFilterValuesFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.has('brandFilter')) {
                document.getElementById('brandFilter').value = urlParams.get('brandFilter');
            }

            if (urlParams.has('yearFilter')) {
                document.getElementById('yearFilter').value = urlParams.get('yearFilter');
            }

            if (urlParams.has('availabilityFilter')) {
                document.getElementById('availabilityFilter').value = urlParams.get('availabilityFilter');
            }

            if (urlParams.has('priceFilter')) {
                document.getElementById('priceFilter').value = urlParams.get('priceFilter');
            }

            if (urlParams.has('searchTerm')) {
                document.getElementById('searchInput').value = urlParams.get('searchTerm');
            }
        }

       
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('brandFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('availabilityFilter').value = '';
            document.getElementById('priceFilter').value = '';

         
            window.location.href = '@Url.Action("Index", "Home")';
        }

        
        function performInstantSearch(query) {
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');

            if (searchInput.value !== query) {
                searchInput.value = query;
                searchForm.submit();
            }
        }

        document.querySelectorAll('#brandFilter, #yearFilter, #availabilityFilter, #priceFilter').forEach(filter => {
            filter.addEventListener('change', function() {
                document.getElementById('searchForm').submit();
            });
        });

       
        document.getElementById('searchForm').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('autocompleteResults').style.display === 'block') {
                e.preventDefault();
            }
        });
    </script>
}